// Generated by CoffeeScript 1.7.1
(function() {
  this.CommentApp || (this.CommentApp = {});

  CommentApp.addComment = function(current, element) {
    var comment, commentEle, commentUserName, par, replyName, request;
    commentUserName = current.find('.user-name');
    commentEle = current.find('.comment-area');
    par = current.closest('li');
    replyName = par.find('.user-name').eq(0).find('.name').text();
    comment = {
      key_id: element,
      user_name: commentUserName.val(),
      reply_name: replyName,
      comment_cont: commentEle.val()
    };
    if ((comment.user_name == null) || comment.user_name.trim() === "") {
      return alert("姓名不能为空");
    } else if ((comment.comment_cont == null) || comment.comment_cont.trim() === "") {
      return alert("评论内容不能为空");
    } else {
      request = $.post('api/comments', {
        comment: comment
      });
      request.fail((function(_this) {
        return function(response) {
          var message;
          message = response.parse(response.responseText).message;
          return alert(message);
        };
      })(this));
      return request.done((function(_this) {
        return function(comment) {
          var floor;
          floor = $('.comments-warper > li').length;
          CommentApp.appendComment(comment, floor);
          commentUserName.val("");
          return commentEle.val("");
        };
      })(this));
    }
  };

  CommentApp.getComments = function() {
    var request;
    request = $.get('api/comments');
    return request.done(function(comments) {
      var comment, floor, leng, _i, _len, _ref, _results;
      leng = comments.length;
      _ref = comments.reverse();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        comment = _ref[_i];
        floor = parseInt(comment.index_init);
        _results.push(CommentApp.appendComment(comment, floor));
      }
      return _results;
    });
  };

  CommentApp.appendComment = function(comment, floor) {
    var childList_warper, childWraper, commentKeyId, dateTime, keyIdIdx, li, liId, opts, par, template;
    dateTime = comment.create_at.split('.')[0].replace('T', ' ');
    comment.create_at = dateTime;
    comment.floor = floor;
    commentKeyId = comment.key_id;
    keyIdIdx = commentKeyId.indexOf('#');
    if (keyIdIdx > 0) {
      liId = commentKeyId.substring(0, keyIdIdx);
      par = $('#' + liId);
      childList_warper = _.template(Templates.childList_warper)(comment);
      template = _.template(Templates.childList_item_template)(comment);
      li = $(template);
      childWraper = par.find('.child-wraper .child-list');
      if (childWraper.length === 0) {
        par.append(childList_warper);
      }
      par.find('.child-wraper .child-list').append(li);
    } else {
      template = _.template(Templates.list_item_template)(comment);
      li = $(template);
      $('#comments').append(li);
    }
    if (comment.remove_opts === false) {
      opts = $('<a hkey="javascript:;" class="reply">回复</a><a hkey="javascript:;" class="danger">删除</a>');
      li.find('.comment-footer').append(opts);
    }
    return CommentApp.watchForChanges(li, comment);
  };

  CommentApp.deleteComment = function(li, comment) {
    var keyId, request;
    comment.comment_cont = "该评论已删除";
    comment.remove_opts = true;
    comment.create_at = $(li).find('.create-time').text().replace(' ', 'T');
    keyId = $(li).attr('id');
    request = $.post('/api/comments/' + keyId, {
      comment: comment,
      _method: 'put'
    });
    request.fail((function(_this) {
      return function(response) {
        var message;
        message = response.parse(response.responseText).message;
        return alert(message);
      };
    })(this));
    return request.done(function() {
      $(li).find('.comment-cont').text("该评论已删除");
      return $(li).find('.comment-footer a').remove();
    });
  };

  CommentApp.watchForChanges = function(li, comment) {
    $('.danger', li).click((function(_this) {
      return function() {
        return CommentApp.deleteComment(li, comment);
      };
    })(this));
    return $('.reply', li).click((function(_this) {
      return function() {
        var reply_box, template;
        $('.reply-box').remove();
        template = _.template(Templates.list_reply_box)();
        reply_box = $(template);
        $(li).find('.comment-self').eq(0).append(reply_box);
        return $(li).siblings().find('.reply-box').remove();
      };
    })(this));
  };

}).call(this);
